apiVersion: eksctl.io/v1alpha5
kind: ClusterConfig

metadata:
  name: busan
  region: ap-northeast-2
  version: "1.34"  # 원하는 Kubernetes 버전

# 기존 VPC 사용
vpc:
  id: "vpc-0addfc51510c52907"
  subnets:
    private:
      ap-northeast-2a: { id: "subnet-0727aaf4f31228d2d" }
      ap-northeast-2b: { id: "subnet-00ec263647c3fb825" }
      ap-northeast-2c: { id: "subnet-00fcd496db9a842f4" }
      ap-northeast-2d: { id: "subnet-0e4da8d622757f738" }

# IAM OIDC Provider 활성화 (필수)
iam:
  withOIDC: true

# Managed Node Group
managedNodeGroups:
  - name: spot-workers
    instanceTypes: 
      - t3.medium
      - t3a.medium
      - m5.large
    spot: true
    privateNetworking: true
    
    # 스케일링 설정
    minSize: 1
    maxSize: 5
    desiredCapacity: 2
    
    # 볼륨 설정
    volumeSize: 30
    volumeType: gp3
    
    # 레이블 및 태그
    labels:
      role: spot-worker
    tags:
      nodegroup-type: spot-managed
    
    # IAM 정책
    iam:
      withAddonPolicies:
        autoScaler: true
        cloudWatch: true
        ebs: true

# 애드온 자동 설치
addons:
  - name: vpc-cni
    version: latest
  - name: coredns
    version: latest
  - name: kube-proxy
    version: latest
  - name: aws-ebs-csi-driver
    version: latest